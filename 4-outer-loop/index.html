<!DOCTYPE html>
<html lang="en" class="js csstransforms3d">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="Hugo 0.69.0" />
    <meta name="description" content="A DevSecOps Workshop Day using openShift and ACS">
<meta name="author" content="GÃ¶tz, Daniel">

    <link rel="icon" href="https://devsecops-workshop.github.io/images/favicon.png" type="image/png">

    <title>Outer Loop :: DevSecOps Workshop</title>

    
    <link href="https://devsecops-workshop.github.io/css/nucleus.css?1686571076" rel="stylesheet">
    <link href="https://devsecops-workshop.github.io/css/fontawesome-all.min.css?1686571076" rel="stylesheet">
    <link href="https://devsecops-workshop.github.io/css/hybrid.css?1686571076" rel="stylesheet">
    <link href="https://devsecops-workshop.github.io/css/featherlight.min.css?1686571076" rel="stylesheet">
    <link href="https://devsecops-workshop.github.io/css/perfect-scrollbar.min.css?1686571076" rel="stylesheet">
    <link href="https://devsecops-workshop.github.io/css/auto-complete.css?1686571076" rel="stylesheet">
    <link href="https://devsecops-workshop.github.io/css/atom-one-dark-reasonable.css?1686571076" rel="stylesheet">
    <link href="https://devsecops-workshop.github.io/css/theme.css?1686571076" rel="stylesheet">
    <link href="https://devsecops-workshop.github.io/css/tabs.css?1686571076" rel="stylesheet">
    <link href="https://devsecops-workshop.github.io/css/hugo-theme.css?1686571076" rel="stylesheet">
    
    <link href="https://devsecops-workshop.github.io/css/theme-red.css?1686571076" rel="stylesheet">
    
    

    <script src="https://devsecops-workshop.github.io/js/jquery-3.3.1.min.js?1686571076"></script>

    <style>
      :root #header + #content > #left > #rlblock_left{
          display:none !important;
      }
      
        :not(pre) > code + span.copy-to-clipboard {
            display: none;
        }
      
    </style>
    
<script src="https://devsecops-workshop.github.io/js/custom.js"></script>
  </head>
  <body class="" data-url="/4-outer-loop/">
    <nav id="sidebar" class="">



  <div id="header-wrapper">
    <div id="header">
      <a id="logo" href="https://devsecops-workshop.github.io/">
    <img src="https://devsecops-workshop.github.io/images/acs-logo.png">
  </a>

    </div>
    
        <div class="searchbox">
    <label for="search-by"><i class="fas fa-search"></i></label>
    <input data-search-input id="search-by" type="search" placeholder="Search...">
    <span data-search-clear=""><i class="fas fa-times"></i></span>
</div>

<script type="text/javascript" src="https://devsecops-workshop.github.io/js/lunr.min.js?1686571076"></script>
<script type="text/javascript" src="https://devsecops-workshop.github.io/js/auto-complete.js?1686571076"></script>
<script type="text/javascript">
    
        var baseurl = "https:\/\/devsecops-workshop.github.io\/";
    
</script>
<script type="text/javascript" src="https://devsecops-workshop.github.io/js/search.js?1686571076"></script>

    
  </div>
  
    <section id="homelinks">
      <ul>
        <li>
            <a class="padding" href='https://devsecops-workshop.github.io/'><i class='fas fa-home'></i> Home</a>
        </li>
      </ul>
    </section>
  

    <div class="highlightable">
    <ul class="topics">

        
          
          




 
  
    
    <li data-nav-id="/1-intro/" title="The DevSecOps Workshop" class="dd-item
        
        
        
        ">
      <a href="https://devsecops-workshop.github.io/1-intro/">
          The DevSecOps Workshop
          
      </a>
      
      
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/2-prepare-cluster/" title="Prepare Cluster" class="dd-item
        
        
        
        ">
      <a href="https://devsecops-workshop.github.io/2-prepare-cluster/">
          Prepare Cluster
          
      </a>
      
      
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/3-inner-loop/" title="Inner Loop" class="dd-item
        
        
        
        ">
      <a href="https://devsecops-workshop.github.io/3-inner-loop/">
          Inner Loop
          
      </a>
      
      
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/4-outer-loop/" title="Outer Loop" class="dd-item
        
        active
        
        ">
      <a href="https://devsecops-workshop.github.io/4-outer-loop/">
          Outer Loop
          
      </a>
      
      
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/5-gitops/" title="Configure GitOps" class="dd-item
        
        
        
        ">
      <a href="https://devsecops-workshop.github.io/5-gitops/">
          Configure GitOps
          
      </a>
      
      
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/10-rhacs-setup/" title="Install and Configure ACS" class="dd-item
        
        
        
        ">
      <a href="https://devsecops-workshop.github.io/10-rhacs-setup/">
          Install and Configure ACS
          
      </a>
      
      
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/11-rhacs-warmup/" title="Getting to know ACS" class="dd-item
        
        
        
        ">
      <a href="https://devsecops-workshop.github.io/11-rhacs-warmup/">
          Getting to know ACS
          
      </a>
      
      
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/12-create-policy/" title="Create a Custom Security Policy" class="dd-item
        
        
        
        ">
      <a href="https://devsecops-workshop.github.io/12-create-policy/">
          Create a Custom Security Policy
          
      </a>
      
      
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/13-rhacs-pipeline/" title="Integrating ACS into the Pipeline" class="dd-item
        
        
        
        ">
      <a href="https://devsecops-workshop.github.io/13-rhacs-pipeline/">
          Integrating ACS into the Pipeline
          
      </a>
      
      
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/15-runtime-security/" title="Securing Runtime Events" class="dd-item
        
        
        
        ">
      <a href="https://devsecops-workshop.github.io/15-runtime-security/">
          Securing Runtime Events
          
      </a>
      
      
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/16-acm/" title="Advanced Cluster Management" class="dd-item
        
        
        
        ">
      <a href="https://devsecops-workshop.github.io/16-acm/">
          Advanced Cluster Management
          
      </a>
      
      
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/20-appendix/" title="Appendix" class="dd-item
        
        
        
        ">
      <a href="https://devsecops-workshop.github.io/20-appendix/">
          Appendix
          
      </a>
      
      
    </li>
  
 

          
        
    </ul>

    
    
      <section id="shortcuts">
        <h3>More</h3>
        <ul>
          
              <li>
                  <a class="padding" href="https://devsecops-workshop.github.io/"><i class='fas fa-home'></i> Homepage</a>
              </li>
          
        </ul>
      </section>
    

    
    <section id="footer">
      <p>Built with <a href="https://github.com/matcornic/hugo-theme-learn"><i class="fas fa-heart"></i></a> from <a href="https://getgrav.org">Grav</a> and <a href="https://gohugo.io/">Hugo</a></p>

    </section>
  </div>
</nav>




        <section id="body">
        <div id="overlay"></div>
        <div class="padding highlightable">
              
              <div>
                <div id="top-bar">
                
                
                <div id="breadcrumbs" itemscope="" itemtype="http://data-vocabulary.org/Breadcrumb">
                    <span id="sidebar-toggle-span">
                        <a href="#" id="sidebar-toggle" data-sidebar-toggle="">
                          <i class="fas fa-bars"></i>
                        </a>
                    </span>
                  
                  <span id="toc-menu"><i class="fas fa-list-alt"></i></span>
                  
                  <span class="links">
                 
                 
                    
          
          
            
            
          
          
            <a href='https://devsecops-workshop.github.io/'></a> > Outer Loop
          
        
          
        
                 
                  </span>
                </div>
                
                    <div class="progress">
    <div class="wrapper">
<nav id="TableOfContents">
  <ul>
    <li><a href="#install-openshift-pipelines">Install OpenShift Pipelines</a></li>
    <li><a href="#create-app-deployment-and-build-pipeline">Create App Deployment and Build Pipeline</a></li>
    <li><a href="#install-red-hat-quay-container-registry">Install Red Hat Quay Container Registry</a></li>
    <li><a href="#integrate-quay-as-registry-into-openshift">Integrate Quay as Registry into OpenShift</a></li>
    <li><a href="#adjust-the-pipeline-to-deploy-to-quay">Adjust the Pipeline to Deploy to Quay</a>
      <ul>
        <li><a href="#create-a-new-s2i-java-clustertask">Create a new <code>s2i-java</code> ClusterTask</a></li>
        <li><a href="#modify-the-pipeline">Modify the Pipeline</a></li>
      </ul>
    </li>
    <li><a href="#create-an-imagestream-tag-with-an-old-image-version">Create an ImageStream Tag with an Old Image Version</a></li>
    <li><a href="#create-a-new-project">Create a new Project</a></li>
    <li><a href="#architecture-recap">Architecture recap</a></li>
  </ul>
</nav>
    </div>
</div>

                
              </div>
            </div>
            
        <div id="head-tags">
        
        </div>
        
        <div id="body-inner">
          
            <h1>
              
              Outer Loop
            </h1>
          

        



	<p>Now that you have seen how a developer can quickly start to code using modern cloud native tooling, it&rsquo;s time to learn how to proceed with the application towards production. The first step is to implement a CI/CD pipeline to automate new builds. Let&rsquo;s call this stage <code>int</code> for integration.</p>
<h2 id="install-openshift-pipelines">Install OpenShift Pipelines</h2>
<p>To create and run the build pipeline you&rsquo;ll use OpenShift Pipelines based on project Tekton. The first step is to install it:</p>
<ul>
<li>Install the <code>Red hat OpenShift Pipelines</code> Operator from OperatorHub with default settings

<div class="notices warning" ><p>Since the Piplines assets are installed asynchronously it is possible that the <code>Pipeline Templates</code> are not yet setup when proceeding immedately to the next step. So now is good time to grab a coffee.</p>
</div>
</li>
</ul>
<h2 id="create-app-deployment-and-build-pipeline">Create App Deployment and Build Pipeline</h2>
<p>After installing the Operator create a new deployment of your game-changing application:</p>
<ul>
<li>Create a new OpenShift project <code>workshop-int</code></li>
<li>Switch to the <strong>OpenShift Developer Console</strong></li>
<li>Click the <strong>+Add</strong> menu entry to the left and choose <strong>Import from Git</strong></li>
<li>As <strong>Git Repo URL</strong> enter the clone URL for the <code>quarkus-build-options</code> repo in your your <code>Gitea</code> instance (There might be a warning about the repo url that you can ignore)</li>
<li>Click <strong>Show advanced Git options</strong> and for <strong>Git reference</strong> enter <code>master</code></li>
<li>As <strong>Import Strategy</strong> select <code>Builder Image</code></li>
<li>As <strong>Builder Image</strong> select <code>Java</code> and <code>openjdk-11-el7 / Red Hat OpenJDK 11 (RHEL 7)</code></li>
<li>As <strong>Application Name</strong> enter <code>workshop-app</code></li>
<li>As <strong>Name</strong> enter <code>workshop</code></li>
<li>Check <strong>Add pipeline</strong></li>
</ul>

<div class="notices warning" ><p>If you don&rsquo;t have the checkbox <strong>Add pipeline</strong> and get the message <code>There are no pipeline templates available for Java and Deployment combination</code> in the next step then just give it few more minutes and reload the page.</p>
</div>

<ul>
<li>Click <strong>Create</strong></li>
<li>In the main menu left, click on <strong>Pipelines</strong> and observe how the Tekton Pipeline is created and run.</li>
</ul>
<h2 id="install-red-hat-quay-container-registry">Install Red Hat Quay Container Registry</h2>
<p>The image that we have just deployed was pushed to the internal OpenShift Registry which is a great starting point for your cloud native journey. But if you require more control over you image repos, a graphical GUI, scalability, internal security scanning and the like you may want to upgrade to <strong>Red Hat Quay</strong>. So as a next step we want to replace the internal registry with Quay.</p>
<p>Quay installation is done through an operator, too:</p>
<ul>
<li>In <strong>Operators-&gt;OperatorHub</strong> filter for <code>Quay</code></li>
<li>Install the <strong>Red Hat Quay</strong> operator with default settings</li>
<li>Create a new namespace <code>quay</code></li>
<li>In the namespace go to <strong>Administration-&gt;LimitRanges</strong> and delete the <code>quay-core-resource-limits</code>
<figure>
    <img src="../images/delete-limit-range.png?width=45pc&amp;classes=border,shadow"/> <figcaption>
            <h4>Click image to enlarge</h4>
        </figcaption>
</figure>
</li>
<li>In the operator overview of the Quay Operator on the <strong>Quay Registry</strong> tile click <strong>Create instance</strong></li>
<li>If the <em>YAML view</em> is shown sitch to <em>Form view</em></li>
<li>Make sure you are in the <code>quay</code> project</li>
<li>Change the name to <code>quay</code></li>
<li>Click <strong>Create</strong></li>
<li>Click the new Quayregistry, scroll down to <strong>Conditions</strong> and wait until the <strong>Available</strong> type changes to <code>True</code>
<figure>
    <img src="../images/quay-available.png?width=50pc&amp;classes=border,shadow"/> <figcaption>
            <h4>Click image to enlarge</h4>
        </figcaption>
</figure>
</li>
</ul>
<p>Now that the Registry is installed you have to configure a superuser:</p>
<ul>
<li>Make sure you are in the <code>quay</code> Project</li>
<li>Go to <strong>Networking-&gt;Routes</strong>, access the Quay portal using the URL of the first route (<code>quay-quay</code>)</li>
<li>Click <strong>Create Account</strong>
<ul>
<li>As username put in <code>quayadmin</code>, a (fake) email address and a password.</li>
</ul>
</li>
<li>Click <strong>Create Account</strong> again</li>
<li>In the OpenShift web console open <strong>Workloads-&gt;Secrets</strong></li>
<li>Search for <code>quay-config-editor-credentials-...</code>, open the secret and copy the values, you&rsquo;ll need them in a second.</li>
<li>Go back to the <strong>Routes</strong> and open the <code>quay-quay-config-editor</code> route</li>
<li>Login with the values of the secret from above</li>
<li>Click <strong>Sign in</strong></li>
<li>Scroll down to <strong>Access Settings</strong></li>
<li>As <strong>Super User</strong> put in <code>quayadmin</code></li>
<li>click <strong>Validate Configuration Changes</strong> and after the validation click <strong>Reconfigure Quay</strong></li>
</ul>
<p>Reconfiguring Quay takes some time. The easiest way to determine if it&rsquo;s been finished is to open the Quay portal (using the <code>quay-quay</code> Route). At the upper right you&rsquo;ll see the username (<code>quayadmin</code>), if you click the username the drop-down should show a link <strong>Super User Admin Panel</strong>. When it shows up you can proceed.</p>
<figure>
    <img src="../images/quay-superuser.png?width=15pc&amp;classes=border,shadow"/> <figcaption>
            <h4>Click image to enlarge</h4>
        </figcaption>
</figure>

<h2 id="integrate-quay-as-registry-into-openshift">Integrate Quay as Registry into OpenShift</h2>
<p>To synchronize the internal default OpenShift Registry with the Quay Registry, <strong>Quay Bridge</strong> is used.</p>
<ul>
<li>In the OperatorHub of your cluster, search for the <strong>Quay Bridge</strong> Operator
<ul>
<li>Install it with default settings</li>
</ul>
</li>
<li>While the Operator is installing, create a new Organization in <strong>Quay</strong>:
<ul>
<li>Access the <strong>Quay</strong> Portal</li>
<li>In the top <em>+</em> menu click <strong>Create New Organization</strong>
<ul>
<li>Name it <code>openshift_integration</code></li>
</ul>
</li>
<li>Click <strong>Create Organization</strong></li>
</ul>
</li>
</ul>
<p>We need an OAuth Application in Quay for the integration:</p>
<ul>
<li>Again In the <strong>Quay</strong> Portal, click the <strong>Applications</strong> icon in the menubar to the left</li>
<li>Click <strong>Create New Application</strong> at the upper right
<ul>
<li>Name it <code>openshift</code>, press Enter and click on the new <code>openshift</code> item by clicking it</li>
</ul>
</li>
<li>In the menubar to the left click the <strong>Generate Token</strong> icon
<ul>
<li>Check all boxes and click <strong>Generate Access token</strong>
<figure>
    <img src="../images/quay-access-token.png?width=45pc&amp;classes=border,shadow"/> <figcaption>
            <h4>Click image to enlarge</h4>
        </figcaption>
</figure>
</li>
<li>In the next view click <strong>Authorize Application</strong> and confirm</li>
<li>In the next view copy the <strong>Access Token</strong> and save it somewhere, we&rsquo;ll need it again</li>
</ul>
</li>
</ul>
<p>Now we finally create an <strong>Quay Bridge</strong> instance. In the OpenShift web console make sure you are in the <code>quay</code> Project. Then:</p>
<ul>
<li>
<p>Create a new Secret</p>
<ul>
<li>Go to <strong>Workloads-&gt;Secrets</strong> and click <strong>Create-&gt;Key/value secret</strong>
<ul>
<li><strong>Secret name</strong>: quay-credentials</li>
<li><strong>Key</strong>: token</li>
<li><strong>Value</strong>: paste the Access Token you generated in the Quay Portal before</li>
<li>Click <strong>Create</strong></li>
</ul>
</li>
</ul>
</li>
<li>
<p>Go to the Red Hat <strong>Quay Bridge</strong> Operator overview (make sure you are in the <code>quay</code> namespace)</p>
</li>
<li>
<p>On the <strong>Quay Integration</strong> tile click <strong>Create Instance</strong></p>
<ul>
<li>Open <strong>Credentials secret</strong>
<ul>
<li><strong>Namespace containing the secret</strong>: <code>quay</code></li>
<li><strong>Key within the secret</strong>: <code>token</code></li>
</ul>
</li>
<li>Copy the Quay Portal hostname (including <code>https://</code>) and paste it into the <strong>Quay Hostname</strong> field</li>
<li>Set <strong>Insecure registry</strong> to <code>true</code></li>
<li>Click <strong>Create</strong></li>
</ul>
</li>
</ul>
<p>And you are done with the installation and integration of Quay as your registry! Test if the integration works:</p>
<ul>
<li>In the Quay Portal you should see your Openshift Projects are synced and represented as Quay Organizations, prefixed with <code>openshift_</code> (you might have to reload the browser).
<ul>
<li>E.g. there should be a <code>openshift_git</code> Quay Organization.</li>
</ul>
</li>
<li>In the OpenShift web console create a new test Project, make sure it&rsquo;s synced to Quay as an Organization and delete it again.</li>
</ul>
<h2 id="adjust-the-pipeline-to-deploy-to-quay">Adjust the Pipeline to Deploy to Quay</h2>
<p>The current Pipeline deploys to the internal Registry by default so the image that was created by the first (automatic) run was pushed there.</p>
<p>To leverage our brand new Quay registry we need to modify the Pipeline so it pushes images to the Quay registry. In addition the ImageStream must be modified to point to the Quay registry, too.</p>
<h3 id="create-a-new-s2i-java-clustertask">Create a new <code>s2i-java</code> ClusterTask</h3>
<p>The first thing is to create a new source-to-image Task to automatically update the <strong>ImageStream</strong> to point to Quay. You could of course copy and modify the default <code>s2i-java</code> task using the build-in YAML editor of the web console. But to make this as painless as possible we have prepared the needed YAML object definition for you already.</p>
<ul>
<li>Login to your bastion host via SSH, from here you can run <code>oc</code> commands</li>
<li>Clone the Git repo with the YAML files you&rsquo;ll need: <code>git clone https://github.com/devsecops-workshop/yaml.git</code></li>
<li>Change into the <code>yaml</code> directory</li>
<li>Apply the first YAML: <code>oc create -f s2i-java-workshop.yml</code></li>
</ul>

<div class="notices warning" ><p>There is an issue with the delivered version of the Skopeo Clustertask, so we will also import an updated version. This may not be necessary in the future
Apply the YAML: <code>oc create -f skopeo-update.yml</code></p>
</div>


<div class="notices tip" ><p>You can do the above steps from any Linux system where you set up the <code>oc</code> command.</p>
</div>

<p>You should now have a new <strong>ClusterTask</strong> named <code>s2i-java-workshop</code>, go to the web console and check:</p>
<ul>
<li>Switch to the <strong>Administrator</strong> console</li>
<li>Switch to the <code>workshop-int</code> Project</li>
<li>Go to <strong>Pipelines</strong>-&gt;<strong>Tasks</strong>-&gt;<strong>ClusterTasks</strong></li>
<li>Search for the <code>s2i-java-workshop</code> ClusterTask and open it</li>
<li>Switch to the YAML view</li>
</ul>
<p>Please take the time to review the additions to the default <code>s2i-java</code> task:</p>
<ul>
<li>In the <code>params</code> section are two new parameters:</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">- <span style="color:#66d9ef">default</span>: <span style="color:#e6db74">&#39;&#39;</span>
    <span style="color:#66d9ef">description</span>: The name of the ImageStream which should be updated
    <span style="color:#66d9ef">name</span>: IMAGESTREAM
    <span style="color:#66d9ef">type</span>: string
- <span style="color:#66d9ef">default</span>: <span style="color:#e6db74">&#39;&#39;</span>
    <span style="color:#66d9ef">description</span>: The Tag of the ImageStream which should be updated
    <span style="color:#66d9ef">name</span>: IMAGESTREAMTAG
    <span style="color:#66d9ef">type</span>: string
</code></pre></div><ul>
<li>At the end of the <code>steps</code> section is a new step:</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">- <span style="color:#66d9ef">env</span>:
    - <span style="color:#66d9ef">name</span>: HOME
      <span style="color:#66d9ef">value</span>: /tekton/home
    <span style="color:#66d9ef">image</span>: <span style="color:#e6db74">&#39;image-registry.openshift-image-registry.svc:5000/openshift/cli:latest&#39;</span>
    <span style="color:#66d9ef">name</span>: update-image-stream
    <span style="color:#66d9ef">resources</span>: {}
    <span style="color:#66d9ef">script</span>: <span style="color:#e6db74">&gt;
</span><span style="color:#e6db74">      #!/usr/bin/env bash</span>

      oc tag --source=docker $(params.IMAGE)
      $(params.IMAGESTREAM):$(params.IMAGESTREAMTAG) --insecure
    <span style="color:#66d9ef">securityContext</span>:
      <span style="color:#66d9ef">runAsNonRoot</span>: <span style="color:#66d9ef">true</span>
      <span style="color:#66d9ef">runAsUser</span>: <span style="color:#ae81ff">65532</span>
</code></pre></div><h3 id="modify-the-pipeline">Modify the Pipeline</h3>
<p>After adding the new task we need to modify the pipeline to:</p>
<ul>
<li>Introduce the new parameters into the Pipeline configuration</li>
<li>Use the new <code>s2i-java-workshop</code> task</li>
</ul>
<p>To make this easier we again provide you with a full YAML definition of the Pipeline. Do the following:</p>
<ul>
<li>Bring up the terminal and make sure you are in the <code>yaml</code> directory.</li>
</ul>

<div class="notices tip" ><p>If you use this lab guide with your domain as query parameter, you are good to go with the command, if not, you have to replace &lt;DOMAIN&gt; manually in the following command.</p>
</div>

<ul>
<li>To replace the <code>DOMAIN</code> placeholder with your lab domain, run: <code>sed -i 's/DOMAIN/&lt;DOMAIN&gt;/g' workshop-pipeline-without-git-update.yml</code></li>
<li>Apply the new definition: <code>oc replace -f workshop-pipeline-without-git-update.yml</code></li>
</ul>
<p>Again take the time to review the changes in the web console:</p>
<ul>
<li>In the menu go to <strong>Pipelines-&gt;Pipelines</strong></li>
<li>Click the <code>workshop</code> Pipeline and switch to YAML</li>
<li>These are the new parameters in the pipeline:</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">- <span style="color:#66d9ef">default</span>: workshop
  <span style="color:#66d9ef">name</span>: IMAGESTREAM
  <span style="color:#66d9ef">type</span>: string
- <span style="color:#66d9ef">default</span>: latest
  <span style="color:#66d9ef">name</span>: IMAGESTREAMTAG
  <span style="color:#66d9ef">type</span>: string
</code></pre></div><ul>
<li>The preexisting parameter <strong>IMAGE_NAME</strong> now points to your local Quay registry:</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">   - <span style="color:#66d9ef">default</span>: &gt;<span style="color:#e6db74">-
</span><span style="color:#e6db74">        quay-quay-quay.apps.&lt;DOMAIN&gt;/openshift_workshop-int/workshop</span>
      <span style="color:#66d9ef">name</span>: IMAGE_NAME
      <span style="color:#66d9ef">type</span>: string
</code></pre></div><p>And finally the <code>build</code> task was modified:</p>
<ul>
<li>The new parameters in the <code>params</code> section of the <code>build</code>:</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#66d9ef">tasks</span>:
    - <span style="color:#66d9ef">name</span>: build
      <span style="color:#66d9ef">params</span>:
        [...]
        - <span style="color:#66d9ef">name</span>: IMAGESTREAM
          <span style="color:#66d9ef">value</span>: $(params.IMAGESTREAM)
        - <span style="color:#66d9ef">name</span>: IMAGESTREAMTAG
          <span style="color:#66d9ef">value</span>: $(params.IMAGESTREAMTAG)
</code></pre></div><ul>
<li>The name of the <code>taskRef</code> was changed to <code>s2i-java-workshop</code>:</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#66d9ef">taskRef</span>:
  <span style="color:#66d9ef">kind</span>: ClusterTask
  <span style="color:#66d9ef">name</span>: s2i-java-workshop
</code></pre></div><p>You are done with adapting the Pipeline to use the Quay registry! Give it a try:</p>
<ul>
<li>First go to the Quay portal to the <code>openshift_workshop-int</code> organization.</li>
<li>In the <code>openshift_workshop-int / workshop</code> repository access <strong>Tags</strong> in the menu to the left. There should be no image (yet).</li>
</ul>
<p>Now it&rsquo;s time to configure and start the Pipeline. In the <strong>Pipelines</strong> view go to the top right menu and choose <strong>Actions -&gt; Start</strong>. In the <strong>Start Pipeline</strong> window that opens, but <strong>before</strong> starting the actual pipeline we need to add a Secret so pipeline can authenticate and push against the Quay repo:</p>
<ul>
<li>Switch to the Quay Portal and click on the <code>openshift_workshop-int / workshop</code> repository</li>
<li>On the left click on <strong>Settings</strong></li>
<li>Click on the <code>openshift_workshop-int+builder</code> Robot account and copy the username and token</li>
<li>Back in the <strong>Start Pipeline</strong> form
<ul>
<li>At the buttom, click on <strong>Show credential options</strong> and then <strong>Add secret</strong></li>
<li>Set these values
<ul>
<li><strong>Secret name</strong> : <code>quay-workshop-int-token</code></li>
<li><strong>Access to</strong> : <code>Image Registry</code></li>
<li><strong>Authentication type</strong> : <code>Basic Authentication</code></li>
<li><strong>Server URL</strong> : <code>quay-quay-quay.apps.&lt;DOMAIN&gt;/openshift_workshop-int</code> (make sure to point to your cluster URL)</li>
<li><strong>Username</strong> : <code>openshift_workshop-int+builder</code></li>
<li><strong>Password or token</strong> : the token you copied from the Quay robot account before &hellip;</li>
</ul>
</li>
<li>Then click on the checkmark below to add the secret</li>
<li>The secret has just been added and will be mounted automatically everytime the pipeline runs</li>
</ul>
</li>
<li>Hit <strong>Start</strong></li>
</ul>
<p>Once the Pipeline run has finished, go to the Quayportal again and check the <strong>Repository</strong> <code>openshift_workshop-int/workshop</code> again. Under <strong>Tags</strong> you should now see a new <code>workshop</code> Image version that was just pushed by the pipeline.</p>
<p>Congratulations : Quay is now a first level citizen of your pipeline build strategy.</p>
<h2 id="create-an-imagestream-tag-with-an-old-image-version">Create an ImageStream Tag with an Old Image Version</h2>
<p>Now there your build pipeline has been set up and is ready. There is one more step in preparation of the security part of this workshop. We need a way to build and deploy from an older image with some security issues in it. For this we will add another ImageStream <code>Tag</code> in the default <code>Java</code> ImageStream that points to an older version with a known issue in it.</p>
<ul>
<li>Using the <strong>Administrator</strong> view, switch to the project <code>openshift</code> and under <strong>Builds</strong> click on the <strong>ImageStreams</strong></li>
<li>Search and open the <strong>ImageStream</strong> <code>java</code></li>
<li>Switch to YAML view and add the following snippet to the <code>spec &gt; tags:</code> section.
<ul>
<li>Be careful to keep the needed indentation!</li>
</ul>
</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">- <span style="color:#66d9ef">name</span>: java-old-image
  <span style="color:#66d9ef">annotations</span>:
    <span style="color:#66d9ef">description</span>: Build and run Java applications using Maven and OpenJDK <span style="color:#ae81ff">8</span>.
    <span style="color:#66d9ef">iconClass</span>: icon-rh-openjdk
    <span style="color:#66d9ef">openshift.io/display-name</span>: Red Hat OpenJDK <span style="color:#ae81ff">8</span> (UBI <span style="color:#ae81ff">8</span>)
    <span style="color:#66d9ef">sampleContextDir</span>: undertow-servlet
    <span style="color:#66d9ef">sampleRepo</span>: <span style="color:#e6db74">&#34;https://github.com/jboss-openshift/openshift-quickstarts&#34;</span>
    <span style="color:#66d9ef">supports</span>: <span style="color:#e6db74">&#34;java:8,java&#34;</span>
    <span style="color:#66d9ef">tags</span>: <span style="color:#e6db74">&#34;builder,java,openjdk&#34;</span>
    <span style="color:#66d9ef">version</span>: <span style="color:#e6db74">&#34;8&#34;</span>
  <span style="color:#66d9ef">from</span>:
    <span style="color:#66d9ef">kind</span>: DockerImage
    <span style="color:#66d9ef">name</span>: <span style="color:#e6db74">&#34;registry.redhat.io/openjdk/openjdk-11-rhel7:1.10-1&#34;</span>
  <span style="color:#66d9ef">generation</span>: <span style="color:#ae81ff">4</span>
  <span style="color:#66d9ef">importPolicy</span>: {}
  <span style="color:#66d9ef">referencePolicy</span>:
    <span style="color:#66d9ef">type</span>: Local
</code></pre></div><p>This will add a tag <code>java-old-image</code> that points to an older version of the RHEL Java image. The image and security vulnerabilities can be inspected in the Red Hat Software Catalog <a href="https://catalog.redhat.com/software/containers/openjdk/openjdk-11-rhel7/5bf57185dd19c775cddc4ce5?tag=1.10-1&amp;push_date=1629294893000&amp;container-tabs=security">here</a></p>
<ul>
<li>Have a look at version <code>1.10-1</code></li>
</ul>
<p>We will use this tag to test our security setup in a later chapter.</p>
<h2 id="create-a-new-project">Create a new Project</h2>
<p>For the subsequent exercises we need a new project:</p>
<ul>
<li>Create a new OpenShift Project <code>workshop-prod</code></li>
</ul>
<h2 id="architecture-recap">Architecture recap</h2>
<figure>
    <img src="../images/workshop_architecture_outer_loop.png?width=50pc&amp;classes=border,shadow"/> <figcaption>
            <h4>Click image to enlarge</h4>
        </figcaption>
</figure>






<footer class=" footline" >
	
</footer>

        
        </div>
        

      </div>

    <div id="navigation">
        
        

        
            
            
                
                    
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        

        


	 
	 
		
			<a class="nav nav-prev" href="https://devsecops-workshop.github.io/3-inner-loop/" title="Inner Loop"> <i class="fa fa-chevron-left"></i></a>
		
		
			<a class="nav nav-next" href="https://devsecops-workshop.github.io/5-gitops/" title="Configure GitOps" style="margin-right: 0px;"><i class="fa fa-chevron-right"></i></a>
		
	
    </div>

    </section>

    <div style="left: -1000px; overflow: scroll; position: absolute; top: -1000px; border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;">
      <div style="border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;"></div>
    </div>
    <script src="https://devsecops-workshop.github.io/js/clipboard.min.js?1686571076"></script>
    <script src="https://devsecops-workshop.github.io/js/perfect-scrollbar.min.js?1686571076"></script>
    <script src="https://devsecops-workshop.github.io/js/perfect-scrollbar.jquery.min.js?1686571076"></script>
    <script src="https://devsecops-workshop.github.io/js/jquery.sticky.js?1686571076"></script>
    <script src="https://devsecops-workshop.github.io/js/featherlight.min.js?1686571076"></script>
    <script src="https://devsecops-workshop.github.io/js/highlight.pack.js?1686571076"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <script src="https://devsecops-workshop.github.io/js/modernizr.custom-3.6.0.js?1686571076"></script>
    <script src="https://devsecops-workshop.github.io/js/learn.js?1686571076"></script>
    <script src="https://devsecops-workshop.github.io/js/hugo-learn.js?1686571076"></script>
    
        
            <script src="https://devsecops-workshop.github.io/mermaid/mermaid.js?1686571076"></script>
        
        <script>
            mermaid.initialize({ startOnLoad: true });
        </script>
    
    

  </body>
</html>
