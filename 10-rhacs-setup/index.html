<!DOCTYPE html>
<html lang="en" class="js csstransforms3d">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="Hugo 0.69.0" />
    <meta name="description" content="A DevSecOps Workshop Day using openShift and ACS">
<meta name="author" content="Götz, Daniel">

    <link rel="icon" href="https://devsecops-workshop.github.io/images/favicon.png" type="image/png">

    <title>Install and Configure ACS :: DevSecOps Workshop 2021</title>

    
    <link href="https://devsecops-workshop.github.io/css/nucleus.css?1643896409" rel="stylesheet">
    <link href="https://devsecops-workshop.github.io/css/fontawesome-all.min.css?1643896409" rel="stylesheet">
    <link href="https://devsecops-workshop.github.io/css/hybrid.css?1643896409" rel="stylesheet">
    <link href="https://devsecops-workshop.github.io/css/featherlight.min.css?1643896409" rel="stylesheet">
    <link href="https://devsecops-workshop.github.io/css/perfect-scrollbar.min.css?1643896409" rel="stylesheet">
    <link href="https://devsecops-workshop.github.io/css/auto-complete.css?1643896409" rel="stylesheet">
    <link href="https://devsecops-workshop.github.io/css/atom-one-dark-reasonable.css?1643896409" rel="stylesheet">
    <link href="https://devsecops-workshop.github.io/css/theme.css?1643896409" rel="stylesheet">
    <link href="https://devsecops-workshop.github.io/css/tabs.css?1643896409" rel="stylesheet">
    <link href="https://devsecops-workshop.github.io/css/hugo-theme.css?1643896409" rel="stylesheet">
    
    <link href="https://devsecops-workshop.github.io/css/theme-red.css?1643896409" rel="stylesheet">
    
    

    <script src="https://devsecops-workshop.github.io/js/jquery-3.3.1.min.js?1643896409"></script>

    <style>
      :root #header + #content > #left > #rlblock_left{
          display:none !important;
      }
      
        :not(pre) > code + span.copy-to-clipboard {
            display: none;
        }
      
    </style>
    
  </head>
  <body class="" data-url="/10-rhacs-setup/">
    <nav id="sidebar" class="">



  <div id="header-wrapper">
    <div id="header">
      <a id="logo" href="https://devsecops-workshop.github.io/">
    <img src="https://devsecops-workshop.github.io/images/acs-logo.png">
  </a>

    </div>
    
        <div class="searchbox">
    <label for="search-by"><i class="fas fa-search"></i></label>
    <input data-search-input id="search-by" type="search" placeholder="Search...">
    <span data-search-clear=""><i class="fas fa-times"></i></span>
</div>

<script type="text/javascript" src="https://devsecops-workshop.github.io/js/lunr.min.js?1643896409"></script>
<script type="text/javascript" src="https://devsecops-workshop.github.io/js/auto-complete.js?1643896409"></script>
<script type="text/javascript">
    
        var baseurl = "https:\/\/devsecops-workshop.github.io\/";
    
</script>
<script type="text/javascript" src="https://devsecops-workshop.github.io/js/search.js?1643896409"></script>

    
  </div>
  
    <section id="homelinks">
      <ul>
        <li>
            <a class="padding" href='https://devsecops-workshop.github.io/'><i class='fas fa-home'></i> Home</a>
        </li>
      </ul>
    </section>
  

    <div class="highlightable">
    <ul class="topics">

        
          
          




 
  
    
    <li data-nav-id="/1-intro/" title="The DevSecOps Workshop" class="dd-item
        
        
        
        ">
      <a href="https://devsecops-workshop.github.io/1-intro/">
          The DevSecOps Workshop
          
      </a>
      
      
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/2-prepare-cluster/" title="Prepare Cluster" class="dd-item
        
        
        
        ">
      <a href="https://devsecops-workshop.github.io/2-prepare-cluster/">
          Prepare Cluster
          
      </a>
      
      
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/3-inner-loop/" title="Inner Loop" class="dd-item
        
        
        
        ">
      <a href="https://devsecops-workshop.github.io/3-inner-loop/">
          Inner Loop
          
      </a>
      
      
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/4-outer-loop/" title="Outer Loop" class="dd-item
        
        
        
        ">
      <a href="https://devsecops-workshop.github.io/4-outer-loop/">
          Outer Loop
          
      </a>
      
      
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/5-gitops/" title="Configure GitOps" class="dd-item
        
        
        
        ">
      <a href="https://devsecops-workshop.github.io/5-gitops/">
          Configure GitOps
          
      </a>
      
      
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/10-rhacs-setup/" title="Install and Configure ACS" class="dd-item
        
        active
        
        ">
      <a href="https://devsecops-workshop.github.io/10-rhacs-setup/">
          Install and Configure ACS
          
      </a>
      
      
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/11-rhacs-warmup/" title="Getting to know ACS" class="dd-item
        
        
        
        ">
      <a href="https://devsecops-workshop.github.io/11-rhacs-warmup/">
          Getting to know ACS
          
      </a>
      
      
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/12-create-policy/" title="Create a Custom Security Policy" class="dd-item
        
        
        
        ">
      <a href="https://devsecops-workshop.github.io/12-create-policy/">
          Create a Custom Security Policy
          
      </a>
      
      
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/13-rhacs-pipeline/" title="Integrating ACS into the Pipeline" class="dd-item
        
        
        
        ">
      <a href="https://devsecops-workshop.github.io/13-rhacs-pipeline/">
          Integrating ACS into the Pipeline
          
      </a>
      
      
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/14-runtime-security/" title="Securing Runtime Events" class="dd-item
        
        
        
        ">
      <a href="https://devsecops-workshop.github.io/14-runtime-security/">
          Securing Runtime Events
          
      </a>
      
      
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/100-playground/" title="Playground" class="dd-item
        
        
        
        ">
      <a href="https://devsecops-workshop.github.io/100-playground/">
          Playground
          
      </a>
      
      
    </li>
  
 

          
        
    </ul>

    
    
      <section id="shortcuts">
        <h3>More</h3>
        <ul>
          
              <li>
                  <a class="padding" href="https://devsecops-workshop.github.io/"><i class='fas fa-home'></i> Homepage</a>
              </li>
          
        </ul>
      </section>
    

    
    <section id="footer">
      <p>Built with <a href="https://github.com/matcornic/hugo-theme-learn"><i class="fas fa-heart"></i></a> from <a href="https://getgrav.org">Grav</a> and <a href="https://gohugo.io/">Hugo</a></p>

    </section>
  </div>
</nav>




        <section id="body">
        <div id="overlay"></div>
        <div class="padding highlightable">
              
              <div>
                <div id="top-bar">
                
                
                <div id="breadcrumbs" itemscope="" itemtype="http://data-vocabulary.org/Breadcrumb">
                    <span id="sidebar-toggle-span">
                        <a href="#" id="sidebar-toggle" data-sidebar-toggle="">
                          <i class="fas fa-bars"></i>
                        </a>
                    </span>
                  
                  <span id="toc-menu"><i class="fas fa-list-alt"></i></span>
                  
                  <span class="links">
                 
                 
                    
          
          
            
            
          
          
            <a href='https://devsecops-workshop.github.io/'></a> > Install and Configure ACS
          
        
          
        
                 
                  </span>
                </div>
                
                    <div class="progress">
    <div class="wrapper">
<nav id="TableOfContents">
  <ul>
    <li><a href="#install-rhacs">Install RHACS</a>
      <ul>
        <li><a href="#install-the-operator">Install the Operator</a></li>
        <li><a href="#install-the-main-component-central">Install the main component <strong>Central</strong></a></li>
        <li><a href="#prepare-to-add-secured-clusters">Prepare to add Secured Clusters</a></li>
        <li><a href="#prepare-the-secured-cluster">Prepare the Secured Cluster</a></li>
        <li><a href="#add-the-cluster-as-securedcluster-to-acs-central">Add the Cluster as <strong>SecuredCluster</strong> to <strong>ACS Central</strong></a></li>
        <li><a href="#create-a-serviceaccount-to-scan-the-internal-registry">Create a serviceaccount to scan the internal registry</a></li>
      </ul>
    </li>
  </ul>
</nav>
    </div>
</div>

                
              </div>
            </div>
            
        <div id="head-tags">
        
        </div>
        
        <div id="body-inner">
          
            <h1>
              
              Install and Configure ACS
            </h1>
          

        



	<p>During the workshop you went through the OpenShift developer experience starting from software development using Quarkus and <code>odo</code>, moving on to automating build and deployment using Tekton pipelines and finally using GitOps for production deployments.</p>
<p>Now it&rsquo;s time to add another extremely important piece to the setup; enhancing application security in a conainerized world. Using the most recent addition to the OpenShift portfolio: <strong>Red Hat Advanced Cluster Security for Kubernetes</strong>!</p>
<h2 id="install-rhacs">Install RHACS</h2>
<h3 id="install-the-operator">Install the Operator</h3>
<ul>
<li>Install the &ldquo;Advanced Cluster Security for Kubernetes&rdquo; operator from OperatorHub with the default values.</li>
</ul>

<div class="notices info" ><p>Red Hat recommends installing the Red Hat Advanced Cluster Security for Kubernetes Operator in the <strong>rhacs-operators</strong> namespace. This will happen by default..</p>
</div>

<h3 id="install-the-main-component-central">Install the main component <strong>Central</strong></h3>

<div class="notices info" ><p>You must install the ACS Central instance in its own project and not in the <strong>rhacs-operator</strong> and <strong>openshift-operator</strong> projects, or in any project in which you have installed the ACS Operator!</p>
</div>

<ul>
<li>Navigate to <strong>Operators → Installed Operators</strong></li>
<li>Select the ACS operator</li>
<li>You should now be in the <strong>rhacs-operator</strong> project the Operator created, create a new <strong>Project</strong> for the Central instance:
<ul>
<li>Select <strong>Project: rhacs-operator → Create project</strong></li>
<li>Create a new project <strong>stackrox</strong> (Red Hat recommends using <strong>stackrox</strong> as the project name.)</li>
</ul>
</li>
<li>Select <strong>Provided APIs → Central → Create Central</strong></li>
<li>Accept the name to <strong>stackrox-central-services</strong> and accept the default values</li>
<li>Click <strong>Create</strong></li>
</ul>
<p>After deployment has finished (&quot;<strong>Status</strong> Conditions: Deployed, Initialized&rdquo;) it can take some time until the application is completely up and running. One easy way to check the state is to switch to the <strong>Developer</strong> console view at the upper left. Then make sure you are in the <strong>rhacs-operator</strong> project and open the <strong>Topology</strong> map. You&rsquo;ll see the three deployments of an <strong>Central</strong> instance:</p>
<ul>
<li><strong>scanner-db</strong></li>
<li><strong>scanner</strong></li>
<li><strong>centrals</strong></li>
</ul>
<p>Wait until all Pods have been scaled up properly.</p>
<p><strong>Verify the Installation</strong></p>
<p>Switch to the <strong>Administrator</strong> console view again. Now to check the installation of your <strong>Central</strong> instance, access the RHACS Portal:</p>
<ul>
<li>Look up the <strong>central-htpasswd</strong> secret that was created to get the password</li>
</ul>

<div class="notices info" ><p>If you access the details of your <strong>Central</strong> instance you&rsquo;ll find the complete commandline using <code>oc</code> to retrieve the password from the secret under <code>Admin Credentials Info</code>. Just sayin&hellip; ;)</p>
</div>

<ul>
<li>Look up  and access the route <strong>central</strong> which was also generated automatically.</li>
</ul>
<p>This will get you to the RHACS portal, accept the self-signed certificate and login as user <strong>admin</strong> with the password from the secret.</p>
<p>Now you have a <strong>Central</strong> instance that provides the following services in an
RHACS setup:</p>
<ul>
<li>
<p>The application management interface and services. It handles data persistence, API interactions, and user interface access. You can use the same <strong>Central</strong> instance to <strong>secure multiple</strong> OpenShift or Kubernetes clusters.</p>
</li>
<li>
<p>Scanner, which is a vulnerability scanner for  scanning container images. It analyzes all image layers to check known vulnerabilities from the Common Vulnerabilities and Exposures (CVEs) list. Scanner also identifies vulnerabilities in packages installed by package managers and in dependencies for multiple programming languages.</p>
</li>
</ul>
<p>To actually do and see anything you need to add a <strong>SecuredCluster</strong> (be it the same or another OpenShift cluster). For effect go to the <strong>RHACS Portal</strong>, the Dashboard should by pretty empty, click on the <strong>Compliance</strong> link in the menu to the left, lots of zero&rsquo;s and empty panels, too.</p>
<p>This is because you don&rsquo;t have a monitored and secured OpenShift cluster yet.</p>
<h3 id="prepare-to-add-secured-clusters">Prepare to add Secured Clusters</h3>
<p>First you have to generate an init bundle which contains certificates and is used to authenticate a <strong>SecuredCluster</strong> to the <strong>Central</strong> instance, again regardless if it&rsquo;s the same cluster as the Central instance or a remote/other cluster.</p>
<p>In the <strong>RHACS Portal</strong>:</p>
<ul>
<li>Navigate to <strong>Platform Configuration → Integrations</strong>.</li>
<li>Under the <strong>Authentication Tokens</strong> section, click on <strong>Cluster Init Bundle</strong>.</li>
<li>Click <strong>Generate bundle</strong></li>
<li>Enter a name for the cluster init bundle and click <strong>Generate</strong>.</li>
<li>Click <strong>Download Kubernetes Secret File</strong> to download the generated bundle.</li>
</ul>
<p>The init bundle needs to be applied on all OpenShift clusters you want to secure &amp; monitor.</p>
<h3 id="prepare-the-secured-cluster">Prepare the Secured Cluster</h3>
<p>For this workshop we run <strong>Central</strong> and <strong>SecuredCluster</strong> on one OpenShift cluster. E.g. we monitor and secure the same cluster the central services live on.</p>
<p><strong>Apply the init bundle</strong></p>
<ul>
<li>Use the <code>oc</code> command to log in to the OpenShift cluster as <code>cluster-admin</code>.
<ul>
<li>The easiest way might be to use the <strong>Copy login command</strong> link from the UI</li>
</ul>
</li>
<li>Switch to the <strong>Project</strong> you installed <strong>ACS Central</strong> in, it should be <code>stackrox</code>.</li>
<li>Run <code>oc create -f &lt;init_bundle&gt;.yaml -n stackrox</code> pointing to the init bundle you downloaded from the Central instance and the Project you created.</li>
<li>This will create a number of secrets:</li>
</ul>
<pre><code>secret/collector-tls created
secret/sensor-tls created
secret/admission-control-tls created
</code></pre><h3 id="add-the-cluster-as-securedcluster-to-acs-central">Add the Cluster as <strong>SecuredCluster</strong> to <strong>ACS Central</strong></h3>
<p>Now you are ready to install the <strong>SecuredClusters</strong> instance, this will deploy the secured cluster services:</p>
<ul>
<li>Go to the <strong>ACS Operator</strong> in <strong>Operators-&gt;Installed Operators</strong></li>
<li>Using the Operator create an instance of the <strong>Secured Cluster</strong> type <strong>in the Project you created</strong> (should be stackrox)</li>
<li>Change the <strong>Cluster Name</strong> for the cluster if you want, it&rsquo;ll appear under this name in the RHACS Portal</li>
<li>And most importantly for <strong>Central Endpoint</strong>  enter the address and port number of your <strong>Central</strong> instance, this is the same as the <strong>RACS Portal</strong>.
<ul>
<li>If the RHACS Portal is available at <code>https://central-stackrox.apps.cluster-65h4j.65h4j.sandbox1803.opentlc.com/</code> the endpoint is <code>central-stackrox.apps.cluster-65h4j.65h4j.sandbox1803.opentlc.com:443</code>.</li>
</ul>
</li>
<li>Under <strong>Admission Control Settings</strong> make sure
<ul>
<li><strong>listenOnCreates</strong>, <strong>listenOnUpdates</strong> and <strong>Listen On Events</strong> is enabled</li>
<li>Set <strong>Contact Image Scanners</strong> to <strong>ScanIfMissing</strong></li>
</ul>
</li>
<li>Click <strong>Create</strong></li>
</ul>
<p>Now go to your <strong>RHACS Portal</strong> again, after a couple of minutes you should see you secured cluster under <strong>Platform Configuration-&gt;Clusters</strong>. Wait until all <strong>Cluster Status</strong> indicators become green.</p>
<h3 id="create-a-serviceaccount-to-scan-the-internal-registry">Create a serviceaccount to scan the internal registry</h3>
<p>To enable scanning of all images in the internal registry, you&rsquo;ll have to</p>
<ul>
<li>add a serviceaccount</li>
<li>assign it the needed privileges</li>
<li>configure an <strong>Integration</strong> in ACS</li>
</ul>
<p><strong>Create ServiceAccount to read images from Registry</strong></p>
<ul>
<li>Make sure you are in the <code>stackrox</code> <strong>Project</strong></li>
<li><strong>User Management -&gt; ServiceAccounts -&gt; Create ServiceAccount</strong></li>
<li>Replace the example name with <code>acs-registry-reader</code> and click <strong>Create</strong></li>
<li>In the new ServiceAccount, under <strong>Secrets</strong> click the <code>...-token-...</code> secret</li>
<li>Under <strong>Data</strong> copy the Token</li>
<li>Using <code>oc</code> give the ServiceAccount the right to <strong>read</strong> images from all projects:</li>
</ul>
<pre><code>oc adm policy add-cluster-role-to-user 'system:image-puller' -z acs-registry-reader -n stackrox
</code></pre><p>or</p>
<pre><code>oc adm policy add-cluster-role-to-user 'system:image-puller' system:serviceaccount:stackrox:acs-registry-reader -n stackrox
</code></pre><p>And you&rsquo;ll need the service address for the registry, look it up e.g. from the <strong>Environment</strong> of a registry pod.</p>
<ul>
<li>It should be something like: <code>image-registry.openshift-image-registry.svc:5000</code></li>
</ul>
<p><strong>Add Registry Integration to ACS</strong></p>
<p>Access the <strong>RHACS Portal</strong> and add an integration of type <strong>Generic Docker Registry</strong> from the <strong>Platform Configuration -&gt; Integrations menu</strong>.</p>
<p>Fill in the fields:</p>
<ul>
<li>Give the integration a unique name that should include the cluster name</li>
<li>Set <strong>Types</strong> to <strong>Registry</strong></li>
<li>Set <strong>Endpoint</strong> to the registry service address</li>
<li>Put in the ServiceAccount name as username and the token you copied above</li>
<li>Select Disable TLS certificate validation</li>
<li>Press the test button to validate the connection and press <strong>Save</strong> when the test is successful.</li>
</ul>

<div class="notices tip" ><p>You can also (this might be easier to maintain) just change the user and password for the exisintg, auto-generated entries for the entries <code>https://image-registry.openshift-image-registry.svc:5000</code> and <code>https://image-registry.openshift-image-registry.svc.cluster.local:5000</code>.</p>
</div>






<footer class=" footline" >
	
</footer>

        
        </div>
        

      </div>

    <div id="navigation">
        
        

        
            
            
                
                    
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        

        


	 
	 
		
			<a class="nav nav-prev" href="https://devsecops-workshop.github.io/5-gitops/" title="Configure GitOps"> <i class="fa fa-chevron-left"></i></a>
		
		
			<a class="nav nav-next" href="https://devsecops-workshop.github.io/11-rhacs-warmup/" title="Getting to know ACS" style="margin-right: 0px;"><i class="fa fa-chevron-right"></i></a>
		
	
    </div>

    </section>

    <div style="left: -1000px; overflow: scroll; position: absolute; top: -1000px; border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;">
      <div style="border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;"></div>
    </div>
    <script src="https://devsecops-workshop.github.io/js/clipboard.min.js?1643896409"></script>
    <script src="https://devsecops-workshop.github.io/js/perfect-scrollbar.min.js?1643896409"></script>
    <script src="https://devsecops-workshop.github.io/js/perfect-scrollbar.jquery.min.js?1643896409"></script>
    <script src="https://devsecops-workshop.github.io/js/jquery.sticky.js?1643896409"></script>
    <script src="https://devsecops-workshop.github.io/js/featherlight.min.js?1643896409"></script>
    <script src="https://devsecops-workshop.github.io/js/highlight.pack.js?1643896409"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <script src="https://devsecops-workshop.github.io/js/modernizr.custom-3.6.0.js?1643896409"></script>
    <script src="https://devsecops-workshop.github.io/js/learn.js?1643896409"></script>
    <script src="https://devsecops-workshop.github.io/js/hugo-learn.js?1643896409"></script>
    
        
            <script src="https://devsecops-workshop.github.io/mermaid/mermaid.js?1643896409"></script>
        
        <script>
            mermaid.initialize({ startOnLoad: true });
        </script>
    
    

  </body>
</html>
