<!DOCTYPE html>
<html lang="en" class="js csstransforms3d">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="Hugo 0.69.0" />
    <meta name="description" content="A DevSecOps Workshop Day using openShift and ACS">
<meta name="author" content="GÃ¶tz, Daniel">

    <link rel="icon" href="https://devsecops-workshop.github.io/images/favicon.png" type="image/png">

    <title>Create a Custom Security Policy :: DevSecOps Workshop</title>

    
    <link href="https://devsecops-workshop.github.io/css/nucleus.css?1712333132" rel="stylesheet">
    <link href="https://devsecops-workshop.github.io/css/fontawesome-all.min.css?1712333132" rel="stylesheet">
    <link href="https://devsecops-workshop.github.io/css/hybrid.css?1712333132" rel="stylesheet">
    <link href="https://devsecops-workshop.github.io/css/featherlight.min.css?1712333132" rel="stylesheet">
    <link href="https://devsecops-workshop.github.io/css/perfect-scrollbar.min.css?1712333132" rel="stylesheet">
    <link href="https://devsecops-workshop.github.io/css/auto-complete.css?1712333132" rel="stylesheet">
    <link href="https://devsecops-workshop.github.io/css/atom-one-dark-reasonable.css?1712333132" rel="stylesheet">
    <link href="https://devsecops-workshop.github.io/css/theme.css?1712333132" rel="stylesheet">
    <link href="https://devsecops-workshop.github.io/css/tabs.css?1712333132" rel="stylesheet">
    <link href="https://devsecops-workshop.github.io/css/hugo-theme.css?1712333132" rel="stylesheet">
    
    <link href="https://devsecops-workshop.github.io/css/theme-red.css?1712333132" rel="stylesheet">
    
    

    <script src="https://devsecops-workshop.github.io/js/jquery-3.3.1.min.js?1712333132"></script>

    <style>
      :root #header + #content > #left > #rlblock_left{
          display:none !important;
      }
      
        :not(pre) > code + span.copy-to-clipboard {
            display: none;
        }
      
    </style>
    
<script src="https://devsecops-workshop.github.io/js/custom.js"></script>
  </head>
  <body class="" data-url="/12-create-policy/">
    <nav id="sidebar" class="">



  <div id="header-wrapper">
    <div id="header">
      <a id="logo" href="https://devsecops-workshop.github.io/">
    <img src="https://devsecops-workshop.github.io/images/acs-logo.png">
  </a>

    </div>
    
        <div class="searchbox">
    <label for="search-by"><i class="fas fa-search"></i></label>
    <input data-search-input id="search-by" type="search" placeholder="Search...">
    <span data-search-clear=""><i class="fas fa-times"></i></span>
</div>

<script type="text/javascript" src="https://devsecops-workshop.github.io/js/lunr.min.js?1712333132"></script>
<script type="text/javascript" src="https://devsecops-workshop.github.io/js/auto-complete.js?1712333132"></script>
<script type="text/javascript">
    
        var baseurl = "https:\/\/devsecops-workshop.github.io\/";
    
</script>
<script type="text/javascript" src="https://devsecops-workshop.github.io/js/search.js?1712333132"></script>

    
  </div>
  
    <section id="homelinks">
      <ul>
        <li>
            <a class="padding" href='https://devsecops-workshop.github.io/'><i class='fas fa-home'></i> Home</a>
        </li>
      </ul>
    </section>
  

    <div class="highlightable">
    <ul class="topics">

        
          
          




 
  
    
    <li data-nav-id="/1-intro/" title="The DevSecOps Workshop" class="dd-item
        
        
        
        ">
      <a href="https://devsecops-workshop.github.io/1-intro/">
          The DevSecOps Workshop
          
      </a>
      
      
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/2-install-prerequisites/" title="Install Prerequisites" class="dd-item
        
        
        
        ">
      <a href="https://devsecops-workshop.github.io/2-install-prerequisites/">
          Install Prerequisites
          
      </a>
      
      
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/2.1-prepare-cluster/" title="Prepare Cluster" class="dd-item
        
        
        
        ">
      <a href="https://devsecops-workshop.github.io/2.1-prepare-cluster/">
          Prepare Cluster
          
      </a>
      
      
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/3-inner-loop/" title="Inner Loop" class="dd-item
        
        
        
        ">
      <a href="https://devsecops-workshop.github.io/3-inner-loop/">
          Inner Loop
          
      </a>
      
      
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/4-outer-loop/" title="Outer Loop" class="dd-item
        
        
        
        ">
      <a href="https://devsecops-workshop.github.io/4-outer-loop/">
          Outer Loop
          
      </a>
      
      
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/5-gitops/" title="Configure GitOps" class="dd-item
        
        
        
        ">
      <a href="https://devsecops-workshop.github.io/5-gitops/">
          Configure GitOps
          
      </a>
      
      
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/10-rhacs-setup/" title="Install and Configure ACS" class="dd-item
        
        
        
        ">
      <a href="https://devsecops-workshop.github.io/10-rhacs-setup/">
          Install and Configure ACS
          
      </a>
      
      
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/11-rhacs-warmup/" title="Getting to know ACS" class="dd-item
        
        
        
        ">
      <a href="https://devsecops-workshop.github.io/11-rhacs-warmup/">
          Getting to know ACS
          
      </a>
      
      
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/12-create-policy/" title="Create a Custom Security Policy" class="dd-item
        
        active
        
        ">
      <a href="https://devsecops-workshop.github.io/12-create-policy/">
          Create a Custom Security Policy
          
      </a>
      
      
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/13-rhacs-pipeline/" title="Integrating ACS into the Pipeline" class="dd-item
        
        
        
        ">
      <a href="https://devsecops-workshop.github.io/13-rhacs-pipeline/">
          Integrating ACS into the Pipeline
          
      </a>
      
      
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/15-runtime-security/" title="Securing Runtime Events" class="dd-item
        
        
        
        ">
      <a href="https://devsecops-workshop.github.io/15-runtime-security/">
          Securing Runtime Events
          
      </a>
      
      
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/16-acm/" title="Advanced Cluster Management" class="dd-item
        
        
        
        ">
      <a href="https://devsecops-workshop.github.io/16-acm/">
          Advanced Cluster Management
          
      </a>
      
      
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/20-appendix/" title="Appendix" class="dd-item
        
        
        
        ">
      <a href="https://devsecops-workshop.github.io/20-appendix/">
          Appendix
          
      </a>
      
      
    </li>
  
 

          
        
    </ul>

    
    
      <section id="shortcuts">
        <h3>More</h3>
        <ul>
          
              <li>
                  <a class="padding" href="https://devsecops-workshop.github.io/"><i class='fas fa-home'></i> Homepage</a>
              </li>
          
        </ul>
      </section>
    

    
    <section id="footer">
      <p>Built with <a href="https://github.com/matcornic/hugo-theme-learn"><i class="fas fa-heart"></i></a> from <a href="https://getgrav.org">Grav</a> and <a href="https://gohugo.io/">Hugo</a></p>

    </section>
  </div>
</nav>




        <section id="body">
        <div id="overlay"></div>
        <div class="padding highlightable">
              
              <div>
                <div id="top-bar">
                
                
                <div id="breadcrumbs" itemscope="" itemtype="http://data-vocabulary.org/Breadcrumb">
                    <span id="sidebar-toggle-span">
                        <a href="#" id="sidebar-toggle" data-sidebar-toggle="">
                          <i class="fas fa-bars"></i>
                        </a>
                    </span>
                  
                  <span id="toc-menu"><i class="fas fa-list-alt"></i></span>
                  
                  <span class="links">
                 
                 
                    
          
          
            
            
          
          
            <a href='https://devsecops-workshop.github.io/'></a> > Create a Custom Security Policy
          
        
          
        
                 
                  </span>
                </div>
                
                    <div class="progress">
    <div class="wrapper">
<nav id="TableOfContents">
  <ul>
    <li><a href="#objective">Objective</a></li>
    <li><a href="#create-a-custom-system-policy">Create a Custom System Policy</a></li>
    <li><a href="#test-the-policy">Test the Policy</a></li>
    <li><a href="#architecture-recap">Architecture recap</a></li>
  </ul>
</nav>
    </div>
</div>

                
              </div>
            </div>
            
        <div id="head-tags">
        
        </div>
        
        <div id="body-inner">
          
            <h1>
              
              Create a Custom Security Policy
            </h1>
          

        



	<h2 id="objective">Objective</h2>
<p>You should have one or more pipelines to build your application from the first workshop part, now we want to secure the build and deployment of it. For the sake of this workshop we&rsquo;ll take a somewhat simplified use case:</p>
<p><strong>We want to scan our application image for the Red Hat Security Advisory RHSA-2021:4904 concerning openssl-lib.</strong></p>
<p>If this RHSA is found in an image we don&rsquo;t want to deploy the application using it.</p>
<p>These are the steps you will go through:</p>
<ul>
<li>Create a custom <strong>Security Policy</strong> to check for the advisory</li>
<li>Test if the policy is triggered in non-enforcing mode
<ul>
<li>with an older image version that contains the issue</li>
<li>and then with a newer version with the issue fixed.</li>
</ul>
</li>
<li>The final goal is to integrate the policy into the build pipeline</li>
</ul>
<h2 id="create-a-custom-system-policy">Create a Custom System Policy</h2>
<p>First create a new policy category and the system policy. In the <strong>ACS Portal</strong> do the following:</p>
<ul>
<li><strong>Platform Configuration-&gt;Policy Management-&gt;Policy categories tab-&gt;Create category</strong>
<ul>
<li>Enter <code>Workshop</code> as <strong>Category name</strong></li>
<li>Click <strong>Create</strong></li>
</ul>
</li>
<li><strong>Platform Configuration-&gt;Policy Management-&gt;Policies tab-&gt;Create policy</strong></li>
<li><strong>Policy Details</strong>
<ul>
<li><strong>Name:</strong> Workshop RHSA-2021:4904</li>
<li><strong>Severity:</strong> Critical</li>
<li><strong>Categories:</strong> Workshop</li>
<li>Click <strong>Next</strong></li>
</ul>
</li>
<li><strong>Policy Behaviour</strong>
<ul>
<li><strong>Lifecycle Stages:</strong> Build, Deploy</li>
<li><strong>Response method</strong>: Inform</li>
<li>Click <strong>Next</strong></li>
</ul>
</li>
<li><strong>Policy Criteria</strong>
<ul>
<li>Find the <strong>CVE</strong> policy criterium under <strong>Drag out policy fields</strong> in <strong>Image contents</strong></li>
<li>Drag &amp; drop it on the drop zone of Policy Section 1</li>
<li>Put <code>RHSA-2021:4904</code> into the <strong>CVE identifier</strong> field</li>
<li>Click <strong>Next</strong></li>
</ul>
</li>
<li><strong>Policy Scope</strong>
<ul>
<li>You could limit the scope the policy is applied in, do nothing for now.</li>
</ul>
</li>
<li><strong>Review Policy</strong>
<ul>
<li>Have a quick look around, if the policy would create a violation you get a preview here.</li>
<li>Click <strong>Save</strong></li>
</ul>
</li>
</ul>
<figure>
    <img src="../images/custom-policy.png?width=30pc&amp;classes=border,shadow"/> <figcaption>
            <h4>Click image to enlarge</h4>
        </figcaption>
</figure>

<h2 id="test-the-policy">Test the Policy</h2>
<p>Start the pipeline with the affected image version:</p>
<ul>
<li>In the <strong>OpenShift Web Console</strong> go to the Pipeline in your <code>workshop-int</code> project, start it and set <strong>Version</strong> to <code>java-old-image</code> (Remember how we set up this <code>ImageStream</code> <code>tag</code> to point to an old and vulnerable version of the image?)</li>
<li>In the <strong>ACS Portal</strong> follow the <strong>Violations</strong> view</li>
</ul>

<div class="notices tip" ><p>To make it easier spotting the violations for this deployment you can filter the list by entering <code>namespace</code> and then <code>workshop-int</code> in the filter bar.</p>
</div>

<ul>
<li>Expected result:
<ul>
<li>You&rsquo;ll see the build deployments (<code>Quarkus-Build-Options-Git-Gsklhg-Build-...</code>) come and go when they are finished.</li>
<li>When the final build is deployed you&rsquo;ll see a violation in <strong>ACS Portal</strong> for policy <code>Workshop RHSA-2021:4904</code> (Check the Time of the violation)</li>
</ul>
</li>
</ul>

<div class="notices tip" ><p>There will be other policy violations listed, triggered by default policies, have a look around. Note that none of the policies is enforced (so that the pipeline build would be stopped) yet!</p>
</div>

<p>Now start the pipeline with the fixed image version that doesn&rsquo;t contain the CVE anymore:</p>
<ul>
<li>Start the pipeline again but this time leave the Java <strong>Version</strong> as is (<code>openjdk-11-el7</code>).</li>
<li>Follow the <strong>Violations</strong> in the <strong>ACS Portal</strong></li>
<li>Expected result:
<ul>
<li>You&rsquo;ll see the build deployments come up and go</li>
<li>When the final build is deployed you&rsquo;ll see the policy violation for <code>Workshop RHSA-2021:4904</code> for your deployment is gone because the image no longer contains it.</li>
</ul>
</li>
</ul>
<p>This shows how ACS is automatically scanning images when they become active against all enabled policies. But we don&rsquo;t want to just <strong>admire a violation</strong> after the image has been deployed, we want to disable the deployment during build time! So the next step is to integrate the check into the build pipeline and enforce it (don&rsquo;t deploy the application).</p>
<h2 id="architecture-recap">Architecture recap</h2>
<figure>
    <img src="../images/workshop_architecture_stackrox.png?width=50pc&amp;classes=border,shadow"/> <figcaption>
            <h4>Click image to enlarge</h4>
        </figcaption>
</figure>






<footer class=" footline" >
	
</footer>

        
        </div>
        

      </div>

    <div id="navigation">
        
        

        
            
            
                
                    
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        

        


	 
	 
		
			<a class="nav nav-prev" href="https://devsecops-workshop.github.io/11-rhacs-warmup/" title="Getting to know ACS"> <i class="fa fa-chevron-left"></i></a>
		
		
			<a class="nav nav-next" href="https://devsecops-workshop.github.io/13-rhacs-pipeline/" title="Integrating ACS into the Pipeline" style="margin-right: 0px;"><i class="fa fa-chevron-right"></i></a>
		
	
    </div>

    </section>

    <div style="left: -1000px; overflow: scroll; position: absolute; top: -1000px; border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;">
      <div style="border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;"></div>
    </div>
    <script src="https://devsecops-workshop.github.io/js/clipboard.min.js?1712333132"></script>
    <script src="https://devsecops-workshop.github.io/js/perfect-scrollbar.min.js?1712333132"></script>
    <script src="https://devsecops-workshop.github.io/js/perfect-scrollbar.jquery.min.js?1712333132"></script>
    <script src="https://devsecops-workshop.github.io/js/jquery.sticky.js?1712333132"></script>
    <script src="https://devsecops-workshop.github.io/js/featherlight.min.js?1712333132"></script>
    <script src="https://devsecops-workshop.github.io/js/highlight.pack.js?1712333132"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <script src="https://devsecops-workshop.github.io/js/modernizr.custom-3.6.0.js?1712333132"></script>
    <script src="https://devsecops-workshop.github.io/js/learn.js?1712333132"></script>
    <script src="https://devsecops-workshop.github.io/js/hugo-learn.js?1712333132"></script>
    
        
            <script src="https://devsecops-workshop.github.io/mermaid/mermaid.js?1712333132"></script>
        
        <script>
            mermaid.initialize({ startOnLoad: true });
        </script>
    
    

  </body>
</html>
