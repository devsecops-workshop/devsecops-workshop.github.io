<!DOCTYPE html>
<html lang="en" class="js csstransforms3d">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="Hugo 0.69.0" />
    <meta name="description" content="A DevSecOps Workshop Day using openShift and ACS">
<meta name="author" content="GÃ¶tz, Daniel">

    <link rel="icon" href="https://devsecops-workshop.github.io/images/favicon.png" type="image/png">

    <title>Configure GitOps :: DevSecOps Workshop</title>

    
    <link href="https://devsecops-workshop.github.io/css/nucleus.css?1662378327" rel="stylesheet">
    <link href="https://devsecops-workshop.github.io/css/fontawesome-all.min.css?1662378327" rel="stylesheet">
    <link href="https://devsecops-workshop.github.io/css/hybrid.css?1662378327" rel="stylesheet">
    <link href="https://devsecops-workshop.github.io/css/featherlight.min.css?1662378327" rel="stylesheet">
    <link href="https://devsecops-workshop.github.io/css/perfect-scrollbar.min.css?1662378327" rel="stylesheet">
    <link href="https://devsecops-workshop.github.io/css/auto-complete.css?1662378327" rel="stylesheet">
    <link href="https://devsecops-workshop.github.io/css/atom-one-dark-reasonable.css?1662378327" rel="stylesheet">
    <link href="https://devsecops-workshop.github.io/css/theme.css?1662378327" rel="stylesheet">
    <link href="https://devsecops-workshop.github.io/css/tabs.css?1662378327" rel="stylesheet">
    <link href="https://devsecops-workshop.github.io/css/hugo-theme.css?1662378327" rel="stylesheet">
    
    <link href="https://devsecops-workshop.github.io/css/theme-red.css?1662378327" rel="stylesheet">
    
    

    <script src="https://devsecops-workshop.github.io/js/jquery-3.3.1.min.js?1662378327"></script>

    <style>
      :root #header + #content > #left > #rlblock_left{
          display:none !important;
      }
      
        :not(pre) > code + span.copy-to-clipboard {
            display: none;
        }
      
    </style>
    
  </head>
  <body class="" data-url="/5-gitops/">
    <nav id="sidebar" class="">



  <div id="header-wrapper">
    <div id="header">
      <a id="logo" href="https://devsecops-workshop.github.io/">
    <img src="https://devsecops-workshop.github.io/images/acs-logo.png">
  </a>

    </div>
    
        <div class="searchbox">
    <label for="search-by"><i class="fas fa-search"></i></label>
    <input data-search-input id="search-by" type="search" placeholder="Search...">
    <span data-search-clear=""><i class="fas fa-times"></i></span>
</div>

<script type="text/javascript" src="https://devsecops-workshop.github.io/js/lunr.min.js?1662378327"></script>
<script type="text/javascript" src="https://devsecops-workshop.github.io/js/auto-complete.js?1662378327"></script>
<script type="text/javascript">
    
        var baseurl = "https:\/\/devsecops-workshop.github.io\/";
    
</script>
<script type="text/javascript" src="https://devsecops-workshop.github.io/js/search.js?1662378327"></script>

    
  </div>
  
    <section id="homelinks">
      <ul>
        <li>
            <a class="padding" href='https://devsecops-workshop.github.io/'><i class='fas fa-home'></i> Home</a>
        </li>
      </ul>
    </section>
  

    <div class="highlightable">
    <ul class="topics">

        
          
          




 
  
    
    <li data-nav-id="/1-intro/" title="The DevSecOps Workshop" class="dd-item
        
        
        
        ">
      <a href="https://devsecops-workshop.github.io/1-intro/">
          The DevSecOps Workshop
          
      </a>
      
      
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/2-prepare-cluster/" title="Prepare Cluster" class="dd-item
        
        
        
        ">
      <a href="https://devsecops-workshop.github.io/2-prepare-cluster/">
          Prepare Cluster
          
      </a>
      
      
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/3-inner-loop/" title="Inner Loop" class="dd-item
        
        
        
        ">
      <a href="https://devsecops-workshop.github.io/3-inner-loop/">
          Inner Loop
          
      </a>
      
      
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/4-outer-loop/" title="Outer Loop" class="dd-item
        
        
        
        ">
      <a href="https://devsecops-workshop.github.io/4-outer-loop/">
          Outer Loop
          
      </a>
      
      
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/5-gitops/" title="Configure GitOps" class="dd-item
        
        active
        
        ">
      <a href="https://devsecops-workshop.github.io/5-gitops/">
          Configure GitOps
          
      </a>
      
      
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/10-rhacs-setup/" title="Install and Configure ACS" class="dd-item
        
        
        
        ">
      <a href="https://devsecops-workshop.github.io/10-rhacs-setup/">
          Install and Configure ACS
          
      </a>
      
      
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/11-rhacs-warmup/" title="Getting to know ACS" class="dd-item
        
        
        
        ">
      <a href="https://devsecops-workshop.github.io/11-rhacs-warmup/">
          Getting to know ACS
          
      </a>
      
      
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/12-create-policy/" title="Create a Custom Security Policy" class="dd-item
        
        
        
        ">
      <a href="https://devsecops-workshop.github.io/12-create-policy/">
          Create a Custom Security Policy
          
      </a>
      
      
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/13-rhacs-pipeline/" title="Integrating ACS into the Pipeline" class="dd-item
        
        
        
        ">
      <a href="https://devsecops-workshop.github.io/13-rhacs-pipeline/">
          Integrating ACS into the Pipeline
          
      </a>
      
      
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/14-advanced-pipeline/" title="Advanced ACS Pipeline" class="dd-item
        
        
        
        ">
      <a href="https://devsecops-workshop.github.io/14-advanced-pipeline/">
          Advanced ACS Pipeline
          
      </a>
      
      
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/15-runtime-security/" title="Securing Runtime Events" class="dd-item
        
        
        
        ">
      <a href="https://devsecops-workshop.github.io/15-runtime-security/">
          Securing Runtime Events
          
      </a>
      
      
    </li>
  
 

          
        
    </ul>

    
    
      <section id="shortcuts">
        <h3>More</h3>
        <ul>
          
              <li>
                  <a class="padding" href="https://devsecops-workshop.github.io/"><i class='fas fa-home'></i> Homepage</a>
              </li>
          
        </ul>
      </section>
    

    
    <section id="footer">
      <p>Built with <a href="https://github.com/matcornic/hugo-theme-learn"><i class="fas fa-heart"></i></a> from <a href="https://getgrav.org">Grav</a> and <a href="https://gohugo.io/">Hugo</a></p>

    </section>
  </div>
</nav>




        <section id="body">
        <div id="overlay"></div>
        <div class="padding highlightable">
              
              <div>
                <div id="top-bar">
                
                
                <div id="breadcrumbs" itemscope="" itemtype="http://data-vocabulary.org/Breadcrumb">
                    <span id="sidebar-toggle-span">
                        <a href="#" id="sidebar-toggle" data-sidebar-toggle="">
                          <i class="fas fa-bars"></i>
                        </a>
                    </span>
                  
                  <span id="toc-menu"><i class="fas fa-list-alt"></i></span>
                  
                  <span class="links">
                 
                 
                    
          
          
            
            
          
          
            <a href='https://devsecops-workshop.github.io/'></a> > Configure GitOps
          
        
          
        
                 
                  </span>
                </div>
                
                    <div class="progress">
    <div class="wrapper">
<nav id="TableOfContents">
  <ul>
    <li><a href="#install-openshift-gitops">Install OpenShift GitOps</a></li>
    <li><a href="#prepare-the-gitops-config-repository">Prepare the GitOps Config Repository</a></li>
    <li><a href="#setup-gitops-project">Setup GitOps Project</a></li>
    <li><a href="#add-kustomize-and-git-push-tekton-task">Add Kustomize and Git Push Tekton Task</a></li>
    <li><a href="#add-tekton-task-to-your-pipeline">Add Tekton Task to Your Pipeline</a></li>
    <li><a href="#update-our-prod-stage-via-pipeline-and-gitops">Update our Prod Stage via Pipeline and GitOps</a></li>
  </ul>
</nav>
    </div>
</div>

                
              </div>
            </div>
            
        <div id="head-tags">
        
        </div>
        
        <div id="body-inner">
          
            <h1>
              
              Configure GitOps
            </h1>
          

        



	<p>Now that our CI/CD build and integration stage is ready we could promote the app version directly to a production stage. But with the help of the GitOps approach, we can leverage our Git System to handle promotion that is tracked through commits and can deploy and configure the whole production environment. This stage is just too critical to configure manually and without audit.</p>
<h2 id="install-openshift-gitops">Install OpenShift GitOps</h2>
<p>So let&rsquo;s start be installing the OpenShift GitOps Operator based on project ArgoCD.</p>
<ul>
<li>Install the <strong>Red Hat OpenShift GitOps</strong> Operator from OperatorHub with default settings

<div class="notices tip" ><p>The installation of the GitOps Operator will give you a clusterwide ArgoCD instance available at the link in the top right menu, but since we want to have an instance to manage just our prod namespaces we will create another ArgoCD in that specific namespace.</p>
</div>
</li>
<li>Create a new OpenShift Project <code>workshop-prod</code></li>
<li>Then in the project <code>workshop-prod</code> click on <strong>Installed Operators</strong> and then <strong>Red Hat OpenShift GitOps</strong>.</li>
<li>On the <strong>ArgoCD</strong> &ldquo;tile&rdquo; click on <strong>Create instance</strong> to create an ArgoCD instance in the <code>workshop-prod</code> project.</li>
</ul>
<!-- ![ArgoCD](../images/argo.png) -->
<figure>
    <img src="../images/argo.png?width=50pc&amp;classes=border,shadow"/> <figcaption>
            <h4>Click image to enlarge</h4>
        </figcaption>
</figure>

<ul>
<li>Keep the settings as they are and click <strong>Create</strong></li>
</ul>
<h2 id="prepare-the-gitops-config-repository">Prepare the GitOps Config Repository</h2>
<ul>
<li>In <code>Gitea</code> create a <strong>New Migration</strong> and clone the Config GitOps Repo which will be the repository that contains our GitOps infrastructure components and state</li>
<li>The URL is <a href="https://github.com/devsecops-workshop/openshift-gitops-getting-started.git">https://github.com/devsecops-workshop/openshift-gitops-getting-started.git</a></li>
</ul>
<p>Have quick look at the structure of this project :</p>
<p><strong>app</strong> - contains yamls for the deployment, service and route resources needed by our application. These will be applied to the cluster. There is also a <code>kustomization.yaml</code> defining that kustomize layers will be applied to all yamls</p>
<p><strong>environments/dev</strong> - contains the <code>kustomization.yaml</code> which will be modified by our builds with new Image versions. ArgoCD will pick up these changes and trigger new deployments.</p>
<h2 id="setup-gitops-project">Setup GitOps Project</h2>
<p>Let&rsquo;s setup the project that tells ArgoCD to watch our config repo and updated resources in the <code>workshop-prod</code> project accordingly.</p>
<ul>
<li>Give namespace <code>workshop-prod</code> permissions to pull images from <code>workshop-int</code></li>
</ul>
<pre><code>oc policy add-role-to-user \
    system:image-puller system:serviceaccount:workshop-prod:default \
    --namespace=workshop-int
</code></pre><ul>
<li>Find the local <strong>ArgoCD URL</strong> by going to <strong>Networking &gt; Routes</strong> in namespace <code>workshop-prod</code></li>
<li>Open the ArgoCD website ignoring the certificate warning</li>
<li>Don&rsquo;t login with OpenShift but with username and password</li>
<li>User is <code>admin</code> and password will be in Secret <code>argocd-cluster</code></li>
</ul>
<p>ArgoCD works with the concept of <strong>Apps</strong>. We will create an App and point it to the Config Git Repo. ArgoCD will look for k8s yaml files in the repo and path and deploy them to the defined namespace. Additionally ArgoCD will also react to changes to the repo and reflect these to the namespace. You can also enable self-healing to prevent configuration drift. If you want find out more about OpenShift GitOps have look <a href="https://docs.openshift.com/container-platform/4.10/cicd/gitops/understanding-openshift-gitops.html">here</a> :</p>
<ul>
<li>Create App
<ul>
<li>Click the <strong>Manage your applications</strong> icon on the left</li>
<li>Click <strong>Create Application</strong></li>
<li><strong>Application Name</strong>: workshop</li>
<li><strong>Project</strong>: default</li>
<li><strong>SYNC POLICY</strong>: Automatic</li>
<li><strong>Repository URL</strong>: Copy the URL of your config repo from Gitea (It should resemble <code>http://repository-git.apps.{YOUR DOMAIN}.com/gitea/openshift-gitops-getting-started.git</code>)</li>
<li><strong>Path</strong>: environments/dev</li>
<li><strong>Cluster URL</strong>: <a href="https://kubernetes.default.svc">https://kubernetes.default.svc</a></li>
<li><strong>Namespace</strong>: workshop-prod</li>
<li>Click <strong>Create</strong></li>
<li>Click on <strong>Sync</strong> and then <strong>Synchronize</strong> to manually trigger the first sync</li>
<li>Click on the <code>workshop</code> to show the deployment graph</li>
</ul>
</li>
</ul>
<p>Watch the resources (<code>Deployment</code>, <code>Service</code>, <code>Route</code>) get rolled out to the namespace <code>workshop-prod</code>. Notice we have also scaled our app to 2 pods in the prod stage as we want some HA.</p>
<p>Our complete prod stage is now configured and controlled though GitOps. But how do we tell ArgoCD that there is a new version of our app to deploy? Well, we will add a step to our build pipeline updating the config repo.</p>
<p>As we do not want to modify our original repo file we will use a tool called <a href="https://kustomize.io/">Kustomize</a> that can add incremental change layers to YAML files. Since ArgoCD permanently watches this repo it will pick up these Kustomize changes.</p>

<div class="notices tip" ><p>It is also possible to update the repo with a Pull request. Then you have an approval process for your prod deployment.</p>
</div>

<h2 id="add-kustomize-and-git-push-tekton-task">Add Kustomize and Git Push Tekton Task</h2>
<p>Let&rsquo;s add a new custom Tekton task that can update the Image <code>tag</code> via Kustomize after the build an then push the change to out git config repo.</p>
<ul>
<li>In the namespace <code>workshop-int</code> switch to the <strong>Administrator</strong> Perspective and go to <strong>Pipelines &gt; Tasks &gt; Create Task</strong></li>
<li>Replace the YAML definition with the following and click <strong>Create</strong>:</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#66d9ef">apiVersion</span>: tekton.dev/v1beta1
<span style="color:#66d9ef">kind</span>: Task
<span style="color:#66d9ef">metadata</span>:
  <span style="color:#66d9ef">annotations</span>:
    <span style="color:#66d9ef">tekton.dev/pipelines.minVersion</span>: <span style="color:#ae81ff">0.12.1</span>
    <span style="color:#66d9ef">tekton.dev/tags</span>: git
  <span style="color:#66d9ef">name</span>: git-update-deployment
  <span style="color:#66d9ef">namespace</span>: workshop-int
  <span style="color:#66d9ef">labels</span>:
    <span style="color:#66d9ef">app.kubernetes.io/version</span>: <span style="color:#e6db74">&#34;0.1&#34;</span>
    <span style="color:#66d9ef">operator.tekton.dev/provider-type</span>: community
<span style="color:#66d9ef">spec</span>:
  <span style="color:#66d9ef">description</span>: This Task can be used to update image digest in a Git repo using kustomize
  <span style="color:#66d9ef">params</span>:
    - <span style="color:#66d9ef">name</span>: GIT_REPOSITORY
      <span style="color:#66d9ef">type</span>: string
    - <span style="color:#66d9ef">name</span>: GIT_USERNAME
      <span style="color:#66d9ef">type</span>: string
    - <span style="color:#66d9ef">name</span>: GIT_PASSWORD
      <span style="color:#66d9ef">type</span>: string
    - <span style="color:#66d9ef">name</span>: CURRENT_IMAGE
      <span style="color:#66d9ef">type</span>: string
    - <span style="color:#66d9ef">name</span>: NEW_IMAGE
      <span style="color:#66d9ef">type</span>: string
    - <span style="color:#66d9ef">name</span>: NEW_DIGEST
      <span style="color:#66d9ef">type</span>: string
    - <span style="color:#66d9ef">name</span>: KUSTOMIZATION_PATH
      <span style="color:#66d9ef">type</span>: string
  <span style="color:#66d9ef">results</span>:
    - <span style="color:#66d9ef">description</span>: The commit SHA
      <span style="color:#66d9ef">name</span>: commit
  <span style="color:#66d9ef">steps</span>:
    - <span style="color:#66d9ef">image</span>: <span style="color:#e6db74">&#34;docker.io/alpine/git:v2.26.2&#34;</span>
      <span style="color:#66d9ef">name</span>: git-clone
      <span style="color:#66d9ef">resources</span>: {}
      <span style="color:#66d9ef">script</span>: <span style="color:#e6db74">|
</span><span style="color:#e6db74">        rm -rf git-update-digest-workdir</span>
        git clone $(params.GIT_REPOSITORY) git-update-digest-workdir
      <span style="color:#66d9ef">workingDir</span>: $(workspaces.workspace.path)
    - <span style="color:#66d9ef">image</span>: <span style="color:#e6db74">&#34;quay.io/wpernath/kustomize-ubi:latest&#34;</span>
      <span style="color:#66d9ef">name</span>: update-digest
      <span style="color:#66d9ef">resources</span>: {}
      <span style="color:#66d9ef">script</span>: <span style="color:#e6db74">&gt;
</span><span style="color:#e6db74">        #!/usr/bin/env bash</span>

        echo <span style="color:#e6db74">&#34;Start&#34;</span>

        pwd

        cd git-update-digest-workdir/$(params.KUSTOMIZATION_PATH)

        pwd


        <span style="color:#75715e">#echo &#34;kustomize edit set image</span>
        <span style="color:#75715e">#$(params.CURRENT_IMAGE)=$(params.NEW_IMAGE)@$(params.NEW_DIGEST)&#34;</span>


        kustomize version


        kustomize edit set image
        $(params.CURRENT_IMAGE)=$(params.NEW_IMAGE)@$(params.NEW_DIGEST)


        echo <span style="color:#e6db74">&#34;##########################&#34;</span>



        echo <span style="color:#e6db74">&#34;### kustomization.yaml ###&#34;</span>



        echo <span style="color:#e6db74">&#34;##########################&#34;</span>


        ls


        cat kustomization.yaml
      <span style="color:#66d9ef">workingDir</span>: $(workspaces.workspace.path)
    - <span style="color:#66d9ef">image</span>: <span style="color:#e6db74">&#34;docker.io/alpine/git:v2.26.2&#34;</span>
      <span style="color:#66d9ef">name</span>: git-commit
      <span style="color:#66d9ef">resources</span>: {}
      <span style="color:#66d9ef">script</span>: <span style="color:#e6db74">&gt;
</span><span style="color:#e6db74">        pwd</span>


        cd git-update-digest-workdir



        git config user.email <span style="color:#e6db74">&#34;tekton-pipelines-ci@redhat.com&#34;</span>



        git config user.name <span style="color:#e6db74">&#34;tekton-pipelines-ci&#34;</span>



        git status



        git add $(params.KUSTOMIZATION_PATH)/kustomization.yaml


        <span style="color:#75715e"># git commit -m &#34;[$(context.pipelineRun.name)] Image digest updated&#34;</span>


        git status


        git commit -m <span style="color:#e6db74">&#34;[ci] Image digest updated&#34;</span>


        git status

        git push



        RESULT_SHA=<span style="color:#e6db74">&#34;$(git rev-parse HEAD | tr -d &#39;\n&#39;)&#34;</span>



        EXIT_CODE=<span style="color:#e6db74">&#34;$?&#34;</span>



        if [ <span style="color:#e6db74">&#34;$EXIT_CODE&#34;</span> != <span style="color:#ae81ff">0</span> ]



        then
          exit $EXIT_CODE
        fi


        <span style="color:#75715e"># Make sure we don&#39;t add a trailing newline to the result!</span>


        echo -n <span style="color:#e6db74">&#34;$RESULT_SHA&#34;</span> &gt; $(results.commit.path)
      <span style="color:#66d9ef">workingDir</span>: $(workspaces.workspace.path)
  <span style="color:#66d9ef">workspaces</span>:
    - <span style="color:#66d9ef">description</span>: The workspace consisting of maven project.
      <span style="color:#66d9ef">name</span>: workspace
</code></pre></div><h2 id="add-tekton-task-to-your-pipeline">Add Tekton Task to Your Pipeline</h2>
<ul>
<li>Go to <strong>Pipelines &gt; Pipelines &gt; workshop</strong> and then YAML</li>
</ul>

<div class="notices tip" ><p>You can edit pipelines either directly in YAML or in the visual <strong>Pipeline Builder</strong>. We will see how to use the Builder later on so let&rsquo;s edit the YAML for now.</p>
</div>

<p>Add the new Task to your Pipeline by adding it to the YAML like this:</p>
<ul>
<li>In the YAML view insert it at the <strong>tasks</strong> level after the <code>deploy</code> task</li>
<li>For the <code>param</code> <code>GIT_REPOSITORY</code> use your git config repo url (eg. replace {YOUR DOMAIN})</li>
<li>Make sure to fix indentation after pasting into the YAML!</li>
</ul>

<div class="notices tip" ><p>In the OpenShift YAML viewer/editor you can mark multiple lines and use <strong>tab</strong> to indent this lines for one step.</p>
</div>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">- <span style="color:#66d9ef">name</span>: git-update-deployment
  <span style="color:#66d9ef">params</span>:
    - <span style="color:#66d9ef">name</span>: GIT_REPOSITORY
      <span style="color:#66d9ef">value</span>: &gt;<span style="color:#e6db74">-
</span><span style="color:#e6db74">        https://repository-git.apps.{YOUR DOMAIN}/gitea/openshift-gitops-getting-started.git</span>
    - <span style="color:#66d9ef">name</span>: GIT_USERNAME
      <span style="color:#66d9ef">value</span>: gitea
    - <span style="color:#66d9ef">name</span>: GIT_PASSWORD
      <span style="color:#66d9ef">value</span>: gitea
    - <span style="color:#66d9ef">name</span>: CURRENT_IMAGE
      <span style="color:#66d9ef">value</span>: &gt;<span style="color:#e6db74">-
</span><span style="color:#e6db74">        image-registry.openshift-image-registry.svc:5000/workshop-int/workshop:latest</span>
    - <span style="color:#66d9ef">name</span>: NEW_IMAGE
      <span style="color:#66d9ef">value</span>: &gt;<span style="color:#e6db74">-
</span><span style="color:#e6db74">        image-registry.openshift-image-registry.svc:5000/workshop-int/workshop</span>
    - <span style="color:#66d9ef">name</span>: NEW_DIGEST
      <span style="color:#66d9ef">value</span>: $(tasks.build.results.IMAGE_DIGEST)
    - <span style="color:#66d9ef">name</span>: KUSTOMIZATION_PATH
      <span style="color:#66d9ef">value</span>: environments/dev
  <span style="color:#66d9ef">runAfter</span>:
    - build
  <span style="color:#66d9ef">taskRef</span>:
    <span style="color:#66d9ef">kind</span>: Task
    <span style="color:#66d9ef">name</span>: git-update-deployment
  <span style="color:#66d9ef">workspaces</span>:
    - <span style="color:#66d9ef">name</span>: workspace
      <span style="color:#66d9ef">workspace</span>: workspace
</code></pre></div><p>The <code>Pipeline</code> should now look like this</p>
<!-- ![workshop Pipeline](../images/tekton.png) -->
<figure>
    <img src="../images/pipeline1.png?width=50pc&amp;classes=border,shadow"/> <figcaption>
            <h4>Click image to enlarge</h4>
        </figcaption>
</figure>

<ul>
<li>Create a secret with credentials for your <code>Gitea</code> repository, so the <code>task</code> can authenticate and push to <code>Gitea</code>. Replace {YOUR DOMAIN} here to match your <code>Gitea</code>URL</li>
<li>You can add this by clicking on the <strong>+</strong> on the top right ob the Web Console</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#66d9ef">kind</span>: Secret
<span style="color:#66d9ef">apiVersion</span>: v1
<span style="color:#66d9ef">metadata</span>:
  <span style="color:#66d9ef">name</span>: gitea
  <span style="color:#66d9ef">namespace</span>: workshop-int
  <span style="color:#66d9ef">annotations</span>:
    <span style="color:#66d9ef">tekton.dev/git-0</span>: <span style="color:#e6db74">&#34;http://repository-git.apps.{YOUR DOMAIN}&#34;</span>
<span style="color:#66d9ef">data</span>:
  <span style="color:#66d9ef">password</span>: Z2l0ZWE=
  <span style="color:#66d9ef">username</span>: Z2l0ZWE=
<span style="color:#66d9ef">type</span>: kubernetes.io/basic-auth
</code></pre></div><p>Now we need to add the secret to the <code>serviceaccount</code> that runs our pipelines so the <code>task</code> can push to our config repo.</p>
<ul>
<li>Go to <strong>User Management &gt; ServiceAccounts &gt; pipeline</strong></li>
<li>To make the secret available during a pipeline run: Open the YAML and in the <code>secrets</code> section add:</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">- <span style="color:#66d9ef">name</span>: gitea
</code></pre></div><ul>
<li>Save and ignore the warning</li>
</ul>
<h2 id="update-our-prod-stage-via-pipeline-and-gitops">Update our Prod Stage via Pipeline and GitOps</h2>
<ul>
<li>
<p>Run the pipeline and see that in your Gitea repo <code>/environment/dev/kustomize.yaml</code> is updated with the new image version

<div class="notices tip" ><p>Notice that the <code>deploy</code> and the <code>git-update</code> steps now run in parallel. This is one of the powers of Tekton. It can scale natively with pods on OpenShift.</p>
</div>
</p>
</li>
<li>
<p>This will tell ArgoCD to update the <code>Deployment</code> with this new image version</p>
</li>
<li>
<p>Check that the new image is rolled out (you may need to sync manually in ArgoCD to speed things up)</p>
</li>
</ul>





<footer class=" footline" >
	
</footer>

        
        </div>
        

      </div>

    <div id="navigation">
        
        

        
            
            
                
                    
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        

        


	 
	 
		
			<a class="nav nav-prev" href="https://devsecops-workshop.github.io/4-outer-loop/" title="Outer Loop"> <i class="fa fa-chevron-left"></i></a>
		
		
			<a class="nav nav-next" href="https://devsecops-workshop.github.io/10-rhacs-setup/" title="Install and Configure ACS" style="margin-right: 0px;"><i class="fa fa-chevron-right"></i></a>
		
	
    </div>

    </section>

    <div style="left: -1000px; overflow: scroll; position: absolute; top: -1000px; border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;">
      <div style="border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;"></div>
    </div>
    <script src="https://devsecops-workshop.github.io/js/clipboard.min.js?1662378327"></script>
    <script src="https://devsecops-workshop.github.io/js/perfect-scrollbar.min.js?1662378327"></script>
    <script src="https://devsecops-workshop.github.io/js/perfect-scrollbar.jquery.min.js?1662378327"></script>
    <script src="https://devsecops-workshop.github.io/js/jquery.sticky.js?1662378327"></script>
    <script src="https://devsecops-workshop.github.io/js/featherlight.min.js?1662378327"></script>
    <script src="https://devsecops-workshop.github.io/js/highlight.pack.js?1662378327"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <script src="https://devsecops-workshop.github.io/js/modernizr.custom-3.6.0.js?1662378327"></script>
    <script src="https://devsecops-workshop.github.io/js/learn.js?1662378327"></script>
    <script src="https://devsecops-workshop.github.io/js/hugo-learn.js?1662378327"></script>
    
        
            <script src="https://devsecops-workshop.github.io/mermaid/mermaid.js?1662378327"></script>
        
        <script>
            mermaid.initialize({ startOnLoad: true });
        </script>
    
    

  </body>
</html>
